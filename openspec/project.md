# 项目上下文

**全局强制性规则：本项目中所有新建或修改的文档必须使用中文编写。**

## 目的

Explorer 是一个现代化的跨平台文件浏览器，旨在提供高效、直观的文件管理体验。项目使用 Rust 构建，确保性能和安全性，并通过 GPUI 框架提供原生级别的图形界面体验。

### 核心目标

1. **跨平台兼容性**：支持 macOS、Linux 和 Windows 平台
2. **高性能文件操作**：提供快速、可靠的文件管理功能
3. **现代化界面**：提供直观、灵活的用户界面，支持多种浏览模式
4. **组件化架构**：采用 Rust workspaces 进行模块化管理，便于维护和扩展

## 技术栈

### 核心技术
- **Rust**：主要编程语言，确保性能和内存安全
- **GPUI**：图形界面框架，用于构建原生级别的用户界面
- **Rust Workspaces**：项目组织结构，分离不同职责的模块

### 项目结构
- **app**：应用程序主模块，包含应用入口和核心逻辑
- **common**：通用数据类型模块，供其他模块共享使用
- **component**：UI 组件模块，包含所有自实现的界面组件
- **storage**：存储抽象层，定义统一的存储接口
- **providers**：存储提供者实现（如本地文件系统、网络驱动等）

## 项目约定

### 代码风格
- 遵循 Rust 标准代码风格（使用 `rustfmt` 格式化）
- 使用 `clippy` 进行代码静态分析
- 优先使用 Rust 惯用法（idiomatic Rust）
- 组件命名采用清晰、描述性的名称
- 文档注释使用中文编写，代码内部注释视情况使用中文或英文

#### 导入语句规范
导入语句必须按以下顺序组织，各组之间用空行分隔：

1. **标准库** (`std::*`)：使用大括号分组
2. **外部库**：按字母顺序排列
3. **项目模块**：按依赖关系排列

**示例**：
```rust
use std::{
    fs::create_dir_all,
    io::stdout,
    sync::Arc,
};

use dirs::home_dir;
use gpui::{prelude::*,*};
use tracing_appender::{
    non_blocking,
    rolling::{RollingFileAppender, Rotation},
};

use explorer_common::*;
use explorer_component::*;
use explorer_storage::*;
```

#### 异步编程规范
- **公开方法避免 async**：组件的公开方法应该是同步的
- **内部异步处理**：使用 `cx.spawn_in()` 和 `cx.background_executor()` 进行异步操作
- **非阻塞原则**：所有 I/O 操作必须在后台线程执行，不能阻塞 UI 线程

**示例**：
```rust
impl Explorer {
    /// 公开方法是同步的
    pub fn init(&mut self, window: &Window, cx: &mut Context<Self>) {
        // 内部使用异步处理
        cx.spawn_in(window, async move |this, cx| {
            let ret = cx.background_executor()
                .spawn(async move {
                    // 后台执行 I/O 操作
                })
                .await;

            // 更新 UI
            let _ = cx.update(|_, cx| {
                let _ = this.update(cx, |model, cx| {
                    cx.notify();
                });
            });
        }).detach();
    }
}
```

#### 组件初始化模式
采用 **new + init** 分离模式：
- `new()` - 创建实例，快速返回
- `init()` - 启动异步初始化，不阻塞创建过程

**理由**：
- 窗口可以立即显示
- 数据在后台加载
- 提供更好的用户体验

### 架构模式

#### 模块化设计
- 使用 Cargo workspace 管理多个独立但相关的 crate
- 每个模块有明确的职责边界
- 通过公共 API 进行模块间通信

#### UI 架构
- 所有 UI 组件基于 GPUI 框架自行实现
- 采用组件化思想，每个组件职责单一
- 状态管理集中处理，避免状态分散

#### 布局系统
- **左右分栏布局**：
  - 左侧：侧边栏区域，显示磁盘分区列表和常用目录（如主目录、下载、文档等）
  - 右侧：主内容区域，显示当前选中目录的内容
- **分栏浏览**：
  - 支持在主内容区域进行横向和纵向分栏
  - 每个分栏可以独立导航不同的目录
- **多标签页**：
  - 每个分栏内支持多标签页浏览
  - 标签页可以在分栏间拖拽移动

### 功能设计原则

#### 文件操作
支持以下基本文件操作：
- **复制**：单文件和多文件复制
- **移动**：文件和目录移动
- **删除**：支持移动到回收站和永久删除
- **重命名**：文件和目录重命名
- **创建**：新建文件和目录
- **其他**：权限管理、属性查看等

#### 性能要求
- 大目录快速加载（延迟加载、虚拟滚动）
- 文件操作异步处理，不阻塞 UI
- 最小化内存占用

#### 用户体验
- 键盘快捷键支持
- 拖拽操作支持
- 上下文菜单
- 搜索和过滤功能

### 测试策略
- 单元测试覆盖核心功能模块
- 集成测试验证模块间交互
- 跨平台测试确保兼容性
- 性能测试监控关键操作的执行效率

### Git 工作流
- 主分支：`main`
- 功能分支：`feature/<feature-name>`
- 修复分支：`fix/<issue-description>`
- 提交信息使用中文，清晰描述变更内容
- 遵循 OpenSpec 规范进行变更管理

## 领域上下文

### 文件系统操作
- 理解不同操作系统的文件系统差异（路径分隔符、权限模型、特殊文件等）
- 处理符号链接、硬链接等特殊文件类型
- 支持隐藏文件和系统文件的显示控制

### 用户界面
- 文件浏览器的常见交互模式（双击打开、右键菜单、拖拽等）
- 多标签页管理
- 分栏视图同步和独立导航

## 重要约束

### 技术约束
- 必须使用 GPUI 框架，所有 UI 组件需自行实现，不依赖现成的组件库
- 使用 Rust 标准库和生态系统工具
- 跨平台兼容性要求，需要考虑不同操作系统的差异

### 性能约束
- UI 响应时间应保持在 60fps
- 大文件操作应提供进度反馈
- 内存使用需要合理控制，避免大目录浏览时内存溢出

### 安全约束
- 文件操作需要适当的权限检查
- 防止路径遍历攻击
- 敏感文件操作需要用户确认

## 外部依赖

### 关键依赖项
- **GPUI**：图形界面框架
- **tokio** 或其他异步运行时：处理异步文件操作
- **serde**：配置文件序列化/反序列化
- **平台特定依赖**：
  - macOS：可能需要使用 Core Foundation 等系统框架
  - Windows：可能需要使用 Windows API
  - Linux：可能需要使用 GTK 或其他库

### 文件系统库
- `std::fs`：标准库文件系统操作
- `walkdir` 或 `ignore`：目录遍历
- 平台特定的文件监控库（如 `notify`）
